<!DOCTYPE html>
<html lang="en-US">
<html>
<head>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/15.4.2/react-dom.js"></script>
<link rel="stylesheet" href="/public/style.css">
<link rel="shortcut icon" type="image/x-icon" href="/public/goblet_icon.ico" />

<!-- This is an easter egg! Congratulations. You did it!-->
<!--Wow hello what a dick is thick!-->

<title>Spotify Lyrics</title>
<meta charset="UTF-8">

<script>
var access_token;
var refresh_token;
var current_song;
var current_lyrics;
var next_lyrics;
  function UserAction() {
      window.location.replace("/login");
  }
  function GetLyrics(songname, artist, id) {
    $.getJSON('/song?song=' + songname +
              '&artist=' + artist + '&id=' + id, function(data) {
        console.log('at least im here')
        var lyrics = data;
        document.getElementById('text2').html = lyrics;
        document.getElementById('text2').textContent = lyrics;
        console.log(access_token);
    });
  }

  function setSong() {
    jQuery.ajax({
      url: 'https://api.spotify.com/v1/me/player/currently-playing',
      type: 'GET',
      beforeSend: function(xhr) {
          console.log('Requesting authorization with token: ' + access_token);
          xhr.setRequestHeader("Authorization", "Bearer " + access_token);
      },
      success: function(res) {
          console.log('Got response from spotify!');
          console.log(res);
          var songname = res.item.name;
          var artist = res.item.artists[0].name;
          var album = res.item.album.name;
          console.log(res.item.id);
          var id = res.item.id
          var txt = 'You are listening to: \n' + songname +
                    '\nby ' + artist +
                    '\nAlbum: ' + album;
          document.getElementById('maintext').innerHtml = txt;
          document.getElementById('maintext').textContent = txt;
          GetLyrics(songname, artist, id);
      }
    });
  }
</script>

</head>
<body background="/public/background.png">

<audio autoplay loop>
  <source src="/public/Wraiths Waltz.mp3" type="audio/mpeg">
</audio>


<ul>
    <li><a class="active" href="/">Home</a></li>
    <li><a href="/about/">About</a></li>
    <li><a href="https://github.com/Simoid/Goblet-Death-and-Rebirth"><img src="/public/github.svg" style="height: 18px"></a></li>
    <li><a href="https://www.facebook.com/gobdevofficial/"><img src="/public/facebook.png" style="height: 18px"></a></li>
</ul>

<h1 id='maintext' style="font-family:verdana; font-size:300%; text-align:center; color:white;">Spotify Lyrics</h1>
<button type="submit" onclick="UserAction()">Login</button>
<button type="submit" onclick="setSong()">Refresh</button>
<div class="text">
  <p id='text2' style="font-family:verdana; font-size:100%; text-align:center; color:white;">Spotify Lyrics</p>
</div>

<script>

  console.log(window.location.href)
  access_token = new URL(window.location.href).hash.split('&').filter(function(el) { if(el.match('access_token') !== null) return true; })[0].split('=')[1];
  refresh_token = new URL(window.location.href).hash.split('&').filter(function(el) { if(el.match('refresh_token') !== null) return true; })[0].split('=')[1];
  console.log('Spotify tokens read.');
  setSong(access_token)

</script>

</body>
</html>
